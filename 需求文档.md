# 重构需求文档：Dye Game Page 模块化

**版本**: 1.0
**目标**: 将 `dye_game_page.dart` 拆分为 MVC 风格的模块，分离数据模型、纯逻辑计算、存储和 UI 组件。
**核心原则**:

1. **就地拆分**: 不引入新的状态管理库（如 Provider/Bloc），保持 `StatefulWidget` 为核心控制器。
2. **逻辑剥离**: 纯数学/算法逻辑必须移出 UI 文件。
3. **UI 组件化**: 复杂的面板和弹窗必须独立。

---

## 1. 目标文件结构

重构后，请在 `lib/pages/dye_game/`（建议新建文件夹）下组织以下文件：

```text
lib/pages/dye_game/
├── dye_game_page.dart       # [保留] 核心页面 (Controller & View 组装)
├── game_models.dart         # [新增] 枚举、数据结构定义
├── game_logic.dart          # [新增] 纯数学计算、组合算法 (无状态, 静态方法)
├── game_storage.dart        # [新增] JSON 解析与本地存储
└── widgets/
    ├── config_panel.dart    # [新增] 配置面板 UI
    └── edit_cell_dialog.dart# [新增] 格子编辑弹窗 UI

```

---

## 2. 详细拆分需求

### 2.1 任务一：提取数据模型 (`game_models.dart`)

**来源**: `dye_game_page.dart` 顶部的 `enum` 和 `extension`。
**操作**:

1. 剪切 `enum _RowPattern` 及其扩展 `extension _RowPatternX`。
2. **重命名**: 去掉下划线，改为 `RowPattern` (Public)。
3. **依赖**: 确保该文件不依赖 Flutter UI 库（除非用于颜色定义）。

### 2.2 任务二：提取纯逻辑计算 (`game_logic.dart`)

**来源**: 页面底部的数学计算和复杂的组合算法。
**性质**: **纯静态方法**，不包含 `context`，不调用 `setState`。
**操作**: 创建 `class GameLogic`，并将以下方法重构为 `static` 方法：

* **基础计算**:
* `digitDiff(int a, int b)` -> 返回差值。
* `pairColor(...)` -> 传入数值和阈值，返回颜色。
* `bitCount(int value)`。


* **复杂算法** (需修改参数，不再直接读取类成员变量，而是通过参数传入数据):
* `calculateBaseCombinations(List<List<CellData>> cells)`。
* `calculateCustomCombinations(...)`。
* `lockFilterSignatureForCell(...)`。



### 2.3 任务三：提取存储服务 (`game_storage.dart`)

**来源**: `_loadState` 和 `_saveState`。
**操作**: 创建 `class GameStorage`。

1. **Load 方法**:
* 签名: `static Future<Map<String, dynamic>?> load()`
* 功能: 读取 SharedPreferences，解析 JSON，处理版本兼容，返回一个包含 `cells`, `customCells`, `mode`, `threshold` 等数据的 Map。
* *重点*: 移除 UI 文件中那几百行丑陋的 `jsonDecode` 和 `if (data is List)` 校验代码。


2. **Save 方法**:
* 签名: `static Future<void> save({required List<List<CellData>> cells, ...})`
* 功能: 将所有状态序列化为 JSON 并存入 SharedPreferences。



### 2.4 任务四：UI 组件抽离 (`widgets/`)

#### A. 配置面板 (`config_panel.dart`)

**来源**: `_buildConfigPanel` 及其辅助小组件。
**操作**:

* 新建 `StatelessWidget` 名为 `GameConfigPanel`。
* **参数化**: 所有状态（如 `threshold`, `mode`, `cross3Compare`）必须通过 `final` 变量传入。
* **回调**: 所有操作必须通过回调函数传出，例如：
```dart
final Function(int) onThresholdChanged;
final Function(CompareMode) onModeChanged;
final VoidCallback onRandomize;

```



#### B. 编辑弹窗 (`edit_cell_dialog.dart`)

**来源**: `_editCell` 方法内部的 `AlertDialog` 构建逻辑。
**操作**:

* 新建 `StatefulWidget` 名为 `EditCellDialog`。
* **参数**: 接收 `CellData` 和 `row`, `col`。
* **逻辑**: 内部维护编辑时的临时状态，点击“保存/确定”时通过 `Navigator.pop(result)` 返回修改后的数据，或者直接在内部回调修改并保存。

### 2.5 任务五：重构核心页面 (`dye_game_page.dart`)

**角色**: **Controller (控制器)**。
**操作**:

1. **清理**: 删除上述已移出的所有代码。
2. **保留**:
* 状态变量 (`_cells`, `_mode`, `_threshold` 等)。
* 生命周期 (`initState` 调用 `GameStorage.load`)。
* 用户交互方法 (`_updateMode`, `_onCellTap`)。


3. **修改调用**:
* 将 `_digitDiff(...)` 替换为 `GameLogic.digitDiff(...)`。
* 在 `_loadState` 中调用 `final data = await GameStorage.load();` 并赋值给本地变量。
* 在 `build` 方法中，实例化 `GameConfigPanel` 并传入回调函数。



---

## 3. 核心页面逻辑流 (Controller Logic)

重构后的 `dye_game_page.dart` 里的方法应该只负责**“串联”**：

```dart
// 示例：修改阈值
void _updateThreshold(int newValue) {
  setState(() {
    _threshold = newValue;
    // 调用逻辑类进行重新计算/染色 (如果染色逻辑没完全移出的情况)
    _applyColoring(); 
  });
  // 调用存储类保存
  GameStorage.save(cells: _cells, threshold: _threshold, ...);
}

// 示例：计算组合
void _calculateTotal() {
  // 从 UI 获取数据传给 Logic 类
  final results = GameLogic.calculateBaseCombinations(_cells);
  // 显示结果
  _showCombinationDialog(results);
}

```

---

## 4. 验收标准 (Acceptance Criteria)

1. **代码行数**: `dye_game_page.dart` 的行数应减少至 **500行以内**。
2. **功能无损**: 重构后的 App 运行表现（染色、计算结果、存档读取）与重构前完全一致。
3. **无红字**: 没有任何编译错误，通过 `flutter analyze`。
4. **可读性**: 复杂的 JSON 解析逻辑不再出现在 UI 层；复杂的数学算法不再混杂在 Widget 构建代码中。

---

## 5. 建议执行顺序

1. **Step 1**: 建立 `game_models.dart`，迁移枚举。
2. **Step 2**: 建立 `game_logic.dart`，迁移数学公式和 `calculate` 算法。(这一步能清理大量代码)。
3. **Step 3**: 建立 `game_storage.dart`，迁移 `_loadState`/`_saveState`。
4. **Step 4**: 建立 `config_panel.dart`，迁移 UI。
5. **Step 5**: 清理主文件 import，确保运行正常。